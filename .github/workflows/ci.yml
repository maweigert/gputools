name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test-linux:
    if: false  # temporarily disabled
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install OpenCL
        run: sudo apt-get update && sudo apt-get install -y pocl-opencl-icd
      - name: Install package
        run: pip install . && pip install -r tests/requirements.txt
      - name: Run tests
        run: pytest -v tests/

  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install OpenCL
        run: brew install pocl
      - name: Install package
        run: |
          ICD_PREFIX=$(brew --prefix opencl-icd-loader)
          CMAKE_ARGS="-DOpenCL_LIBRARY=$ICD_PREFIX/lib/libOpenCL.dylib -DOpenCL_INCLUDE_DIR=$ICD_PREFIX/include" \
            pip install --no-binary pyopencl pyopencl
          pip install . && pip install -r tests/requirements.txt
      - name: Verify OpenCL
        run: |
          otool -L $(python -c "import pyopencl._cl as m; print(m.__file__)")
          ls /opt/homebrew/etc/OpenCL/vendors/ || true
          ls /opt/homebrew/lib/libOpenCL* || true
          python -c "
          import pyopencl as cl
          platforms = cl.get_platforms()
          print('Platforms:', platforms)
          for p in platforms:
              print(f'  {p.name}:')
              try:
                  print(f'    devices: {p.get_devices()}')
              except Exception as e:
                  print(f'    error: {e}')
          "
      - name: Run tests
        env:
          LIBRARY_PATH: /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib
        run: pytest -v tests/
